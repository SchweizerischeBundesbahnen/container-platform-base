# cluster-inventory

The goal of the cluster-inventory is to provide a machine- (prio 1) and human-readable (prio 2), auto generated (and therefore close to allways up-to-date) inventory of the container platform. The inventory should provide information such as a list of what clusters are available on the platform, on which clouds the clusters are, etc.

## Base idea

Each cluster has one or more ConfigMaps in the cluster-inventory namespace that are readable by everyone:

```
$ curl -s https://api.cluster-a.sbb.ch:6443/api/v1/namespaces/cluster-inventory/configmaps/cluster-inventory | jq -r .data.inventory | jq .data.inventory
{
  "cloud": {
    "id": "aws",
    "locations": [
      "Frankfurt"
    ],
    "provider": "AWS"
  },
  "dnsDomains": {
    "intern": [
      "app-int.sbb.ch"
    ],
    "public": [
      "app.sbb.ch"
    ],
    "wildcard": "*.apps.cluster-a.sbb.ch",
    "zone": {
      "name": "sbb.ch"
    }
  },
  "endpoints": {
    "api": "api.cluster-a.sbb.ch:6443",
    "console": "console-openshift-console.cluster-a.sbb.ch"
  },
  "features": {
    "batchnodes": {
      "enabled": true
    }
  },
  "name": "cluster-a",
  "network": {
    "zone": "public"
  },
  "stage": "prod",
  "type": "shared"
}
```

The default inventory, containing basic information about each cluster, is generated by a template in this application (see `templates/configmap-cluster-inventory.yaml`).

## Adding inventory information

To integrate additional information into the inventory, it is necessary to add them to the "cluster-inventory" ConfigMap of each cluster.

Additional data must be injected as separate keys in the `.data` section of the ConfigMap. This needs to be done either without modifying the `kubectl.kubernetes.io/last-applied-configuration` label or removing it after adding new data:

```
oc annotate configmaps -n cluster-inventory cluster-inventory kubectl.kubernetes.io/last-applied-configuration-
```

This is necessary because the `kubectl` annotation is used by ArgoCD to determine which fields it is manageing itself, so it must be ensured that ArgoCD never considers itself responsible for fields injected outside of ArgoCD. This constraint might be removed when ArgoCD support server-side-apply (https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/#server-side-apply).

The `.data.inventory` key of the ConfigMap is managed by this application so it cannot be modified without chaning the template here, as all other changes would be overwritten by ArgoCD.
